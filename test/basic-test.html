<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
    <script src="../node_modules/mocha/mocha.js"></script>
    <script src="../node_modules/chai/chai.js"></script>
    <script src="../node_modules/wct-mocha/wct-mocha.js"></script>

    <script type="module" src="../../../@polymer/polymer/lib/utils/render-status.js"></script>
    <script type="module" src="../raml-aware.js"></script>
  </head>
  <body>
    <test-fixture id="a1">
      <template>
        <raml-aware></raml-aware>
      </template>
    </test-fixture>
    <test-fixture id="a2">
      <template>
        <raml-aware scope="test"></raml-aware>
      </template>
    </test-fixture>
    <test-fixture id="a3">
      <template>
        <raml-aware></raml-aware>
      </template>
    </test-fixture>
    <test-fixture id="a4">
      <template>
        <raml-aware scope="test"></raml-aware>
      </template>
    </test-fixture>

    <script type="module">
import {afterNextRender} from '../../../@polymer/polymer/lib/utils/render-status.js';
suite('basic', () => {
  let a1;
  let a2;
  let a3;
  let a4;
  setup(() => {
    a1 = fixture('a1');
    a2 = fixture('a2');
    a3 = fixture('a3');
    a4 = fixture('a4');
  });

  teardown(() => {
    a1.raml = undefined;
    a2.raml = undefined;
    a3.raml = undefined;
    a4.raml = undefined;
    a1.parentNode.removeChild(a1);
    a2.parentNode.removeChild(a2);
    a3.parentNode.removeChild(a3);
    a4.parentNode.removeChild(a4);
  });

  test('Sets default scope', () => {
    assert.equal(a1.scope, 'default');
    assert.equal(a3.scope, 'default');
  });

  test('Respects scope from attribute', () => {
    assert.equal(a2.scope, 'test');
    assert.equal(a4.scope, 'test');
  });

  test('Sets data on default scopes only', () => {
    const obj = {a: 'b'};
    a1.raml = obj;
    assert.equal(a3.raml.a, 'b');
    assert.isUndefined(a2.raml);
    assert.isUndefined(a4.raml);
  });

  test('Sets data on defined scopes only', () => {
    const obj = {b: 'c'};
    a2.raml = obj;
    assert.isUndefined(a1.raml);
    assert.isUndefined(a3.raml);
    assert.equal(a4.raml.b, 'c');
  });

  test('`raml-aware` should set RAML for test scope', () => {
    const obj = {'a': 'b'};
    a2.raml = obj;
    assert.deepEqual(a4.raml, obj);
  });
  test('`raml-aware` should not set RAML on other scopes', () => {
    const obj = {'a': 'b'};
    a1.raml = obj;
    assert.notDeepEqual(a2.raml, obj);
  });
});

suite('Data cleanup', () => {
  let a1;
  let a2;
  let a3;

  function create(raml) {
    const a = document.createElement('raml-aware');
    a.raml = raml;
    document.body.appendChild(a);
    return a;
  }

  test('Seeps reference to the data when one is removed', (done) => {
    a1 = create('test');
    a2 = create();
    a1.parentNode.removeChild(a1);
    a3 = create();
    afterNextRender(window, () => {
      assert.equal(a3.raml, 'test');
      a3.parentNode.removeChild(a3);
      done();
    });
  });

  test('Removing only aware clears data', (done) => {
    a2.parentNode.removeChild(a2);
    a3 = create();
    afterNextRender(window, () => {
      assert.isUndefined(a3.raml);
      done();
    });
  });
});
</script>

  </body>
</html>
